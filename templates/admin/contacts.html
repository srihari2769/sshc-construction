{% extends "admin/base.html" %}

{% block page_title %}Manage Contacts{% endblock %}

{% block content %}
<div class="page-actions">
    <div class="filter-buttons">
        <a href="{{ url_for('admin_contacts', status='all') }}" class="btn {{ 'btn-primary' if current_status == 'all' else 'btn-outline' }}">All</a>
        <a href="{{ url_for('admin_contacts', status='new') }}" class="btn {{ 'btn-primary' if current_status == 'new' else 'btn-outline' }}">New</a>
        <a href="{{ url_for('admin_contacts', status='read') }}" class="btn {{ 'btn-primary' if current_status == 'read' else 'btn-outline' }}">Read</a>
        <a href="{{ url_for('admin_contacts', status='responded') }}" class="btn {{ 'btn-primary' if current_status == 'responded' else 'btn-outline' }}">Responded</a>
    </div>
</div>

<div class="table-responsive">
    <table class="data-table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Subject</th>
                <th>Message</th>
                <th>Date</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for contact in contacts %}
            <tr>
                <td>{{ contact.name }}</td>
                <td>{{ contact.email }}</td>
                <td>{{ contact.phone if contact.phone else 'N/A' }}</td>
                <td>{{ contact.subject if contact.subject else 'N/A' }}</td>
                <td>{{ contact.message[:50] }}...</td>
                <td>{{ contact.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                <td>
                    <select class="status-select" onchange="updateContactStatus({{ contact.id }}, this.value)">
                        <option value="new" {{ 'selected' if contact.status == 'new' else '' }}>New</option>
                        <option value="read" {{ 'selected' if contact.status == 'read' else '' }}>Read</option>
                        <option value="responded" {{ 'selected' if contact.status == 'responded' else '' }}>Responded</option>
                    </select>
                </td>
                <td>
                    <button onclick='viewContactMessage({{ contact.id }}, "{{ contact.name | replace('"', '&quot;') }}", "{{ contact.email | replace('"', '&quot;') }}", "{{ contact.message | replace('\n', '\\n') | replace('"', '&quot;') }}")' class="btn btn-small btn-info">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button onclick="deleteItem('contact', {{ contact.id }})" class="btn btn-small btn-danger">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="8" class="text-center">No contacts found.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Contact Message Modal -->
<div id="contactModal" class="modal">
    <div class="modal-content">
        <span class="modal-close">&times;</span>
        <h2>Contact Message</h2>
        <div id="contactDetails"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function viewContactMessage(id, name, email, message) {
    const modal = document.getElementById('contactModal');
    const details = document.getElementById('contactDetails');
    details.innerHTML = `
        <p><strong>Name:</strong> ${name}</p>
        <p><strong>Email:</strong> <a href="mailto:${email}">${email}</a></p>
        <p><strong>Message:</strong></p>
        <p>${message.replace(/\n/g, '<br>')}</p>
    `;
    modal.style.display = 'block';
}

document.querySelector('.modal-close').onclick = function() {
    document.getElementById('contactModal').style.display = 'none';
}

window.onclick = function(event) {
    const modal = document.getElementById('contactModal');
    if (event.target == modal) {
        modal.style.display = 'none';
    }
}

function updateContactStatus(id, status) {
    fetch(`/admin/contacts/${id}/status`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({status: status})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Status updated successfully', 'success');
        }
    });
}
</script>
{% endblock %}
